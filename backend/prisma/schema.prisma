generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Profile {
  id        String   @id @default(uuid()) @db.Uuid
  email     String   @unique
  password  String
  role      Role
  fullName  String?  @map("full_name")
  createdAt DateTime @default(now()) @map("created_at")
  
  student   Student?
  teacher   Teacher?
  notices   Notice[]
  
  @@map("profiles")
}

enum Role {
  ADMIN
  TEACHER
  STUDENT
}

model Student {
  id                String    @id @db.Uuid
  studentCode       String    @unique @map("student_code")
  rollNo            Int?      @map("roll_no")
  regNo             String?   @map("reg_no")
  currentSemesterId Int?      @map("current_semester_id")
  phone             String?
  address           String?
  dob               DateTime? @db.Date
  programId         Int?      @map("program_id")
  
  profile           Profile      @relation(fields: [id], references: [id], onDelete: Cascade)
  semester          Semester?    @relation(fields: [currentSemesterId], references: [id])
  program           Program?     @relation(fields: [programId], references: [id])
  attendance        Attendance[]
  marks             Mark[]
  projects          InternshipProject[]
  submissions       Submission[]
  enrolledClasses   StudentClass[]
  quizAttempts      QuizAttempt[]
  
  @@map("students")
}

model Teacher {
  id                String              @id @db.Uuid
  employeeId        String              @unique @map("employee_id")
  department        String?
  qualification     String?
  programId         Int?                @map("program_id")
  
  profile           Profile             @relation(fields: [id], references: [id], onDelete: Cascade)
  program           Program?            @relation(fields: [programId], references: [id])
  assignments       SubjectAssignment[]
  courseAssignments CourseAssignment[]
  teacherAssignments Assignment[]
  quizzes           Quiz[]
  classMaterials    ClassMaterial[]
  
  @@map("teachers")
}

model Semester {
  id        Int       @id @default(autoincrement())
  name      String
  batchYear Int       @map("batch_year")
  programId Int?      @map("program_id")
  
  program       Program?      @relation(fields: [programId], references: [id])
  subjects      Subject[]
  students      Student[]
  examSchedules ExamSchedule[]
  routines      Routine[]
  
  @@map("semesters")
}

model Program {
  id        Int      @id @default(autoincrement())
  code      String   @unique // e.g. BCA, CSIT
  name      String   // e.g. Bachelor of Computer Applications
  createdAt DateTime @default(now()) @map("created_at")

  semesters Semester[]
  students  Student[]
  teachers  Teacher[]

  @@map("programs")
}

model Subject {
  id          Int                 @id @default(autoincrement())
  code        String
  name        String
  creditHours Int                 @default(3) @map("credit_hours")
  fullMarks   Int                 @default(100) @map("full_marks")
  passMarks   Int                 @default(40) @map("pass_marks")
  semesterId  Int                 @map("semester_id")
  
  semester          Semester            @relation(fields: [semesterId], references: [id], onDelete: Cascade)
  assignments       SubjectAssignment[]
  attendance        Attendance[]
  marks             Mark[]
  courseAssignments CourseAssignment[]
  examSchedules     ExamSchedule[]
  routines          Routine[]
  subjectAssignments Assignment[]
  enrolledStudents  StudentClass[]
  quizzes           Quiz[]
  classMaterials    ClassMaterial[]
  
  @@map("subjects")
}

model SubjectAssignment {
  id           Int     @id @default(autoincrement())
  teacherId    String  @db.Uuid @map("teacher_id")
  subjectId    Int     @map("subject_id")
  academicYear Int     @map("academic_year")
  
  teacher      Teacher @relation(fields: [teacherId], references: [id], onDelete: Cascade)
  subject      Subject @relation(fields: [subjectId], references: [id], onDelete: Cascade)
  
  @@unique([teacherId, subjectId, academicYear])
  @@map("subject_assignments")
}

model StudentClass {
  id        Int      @id @default(autoincrement())
  studentId String   @db.Uuid @map("student_id")
  subjectId Int      @map("subject_id")
  joinedAt  DateTime @default(now()) @map("joined_at")

  student   Student  @relation(fields: [studentId], references: [id], onDelete: Cascade)
  subject   Subject  @relation(fields: [subjectId], references: [id], onDelete: Cascade)

  @@unique([studentId, subjectId])
  @@map("student_classes")
}

model Attendance {
  id        Int              @id @default(autoincrement())
  studentId String           @db.Uuid @map("student_id")
  subjectId Int              @map("subject_id")
  date      DateTime         @default(now()) @db.Date
  status    AttendanceStatus
  
  student   Student          @relation(fields: [studentId], references: [id], onDelete: Cascade)
  subject   Subject          @relation(fields: [subjectId], references: [id], onDelete: Cascade)
  
  @@unique([studentId, subjectId, date])
  @@map("attendance")
}

enum AttendanceStatus {
  PRESENT
  ABSENT
  LATE
}

model Mark {
  id             Int     @id @default(autoincrement())
  studentId      String  @db.Uuid @map("student_id")
  subjectId      Int     @map("subject_id")
  examType       String  @default("Terminal") @map("exam_type")
  internalMarks  Float   @default(0) @map("internal_marks")
  practicalMarks Float   @default(0) @map("practical_marks")
  finalMarks     Float   @default(0) @map("final_marks")
  gradePoint     Float?  @map("grade_point")
  gradeLetter    String? @map("grade_letter")
  
  student        Student @relation(fields: [studentId], references: [id], onDelete: Cascade)
  subject        Subject @relation(fields: [subjectId], references: [id], onDelete: Cascade)
  
  @@unique([studentId, subjectId, examType])
  @@map("marks")
}

model CourseAssignment {
  id          Int      @id @default(autoincrement())
  subjectId   Int      @map("subject_id")
  teacherId   String   @db.Uuid @map("teacher_id")
  title       String
  description String?
  dueDate     DateTime @map("due_date")
  maxMarks    Int?     @map("max_marks")
  createdAt   DateTime @default(now()) @map("created_at")

  subject     Subject  @relation(fields: [subjectId], references: [id], onDelete: Cascade)
  teacher     Teacher  @relation(fields: [teacherId], references: [id], onDelete: Cascade)

  @@map("course_assignments")
}

model ExamSchedule {
  id         Int      @id @default(autoincrement())
  semesterId Int      @map("semester_id")
  subjectId  Int      @map("subject_id")
  examType   ExamType @map("exam_type")
  date       DateTime @db.Date
  startTime  String   @map("start_time")
  endTime    String   @map("end_time")
  room       String?

  semester   Semester @relation(fields: [semesterId], references: [id], onDelete: Cascade)
  subject    Subject  @relation(fields: [subjectId], references: [id], onDelete: Cascade)

  @@map("exam_schedules")
}

enum ExamType {
  MID_TERM
  FINAL
  LAB_VIVA
}

model InternshipProject {
  id          Int           @id @default(autoincrement())
  studentId   String        @db.Uuid @map("student_id")
  type        ProjectType
  title       String
  description String?
  company     String?
  supervisor  String?
  status      ProjectStatus @default(IN_PROGRESS)
  startDate   DateTime      @map("start_date") @db.Date
  endDate     DateTime?     @map("end_date") @db.Date

  student     Student       @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@map("internship_projects")
}

enum ProjectType {
  INTERNSHIP
  PROJECT
}

enum ProjectStatus {
  IN_PROGRESS
  COMPLETED
  ON_HOLD
}

model Notice {
  id            Int            @id @default(autoincrement())
  title         String
  content       String
  priority      NoticePriority @default(NORMAL)
  targetRole    Role?
  attachmentUrl String?        @map("attachment_url")
  createdById   String         @db.Uuid @map("created_by_id")
  createdAt     DateTime       @default(now()) @map("created_at")
  
  createdBy     Profile        @relation(fields: [createdById], references: [id], onDelete: Cascade)
  
  @@map("notices")
}

enum NoticePriority {
  LOW
  NORMAL
  HIGH
  URGENT
}

model Routine {
  id         Int     @id @default(autoincrement())
  semesterId Int     @map("semester_id")
  dayOfWeek  Int     @map("day_of_week")
  startTime  String  @map("start_time")
  endTime    String  @map("end_time")
  subjectId  Int     @map("subject_id")
  room       String?
  
  semester   Semester @relation(fields: [semesterId], references: [id], onDelete: Cascade)
  subject    Subject  @relation(fields: [subjectId], references: [id], onDelete: Cascade)
  
  @@map("routines")
}

model Assignment {
  id            Int          @id @default(autoincrement())
  subjectId     Int          @map("subject_id")
  teacherId     String       @db.Uuid @map("teacher_id")
  title         String
  description   String?
  dueDate       DateTime     @map("due_date")
  maxMarks      Int          @default(100) @map("max_marks")
  attachmentUrl String?      @map("attachment_url")
  createdAt     DateTime     @default(now()) @map("created_at")
  
  subject       Subject      @relation(fields: [subjectId], references: [id], onDelete: Cascade)
  teacher       Teacher      @relation(fields: [teacherId], references: [id], onDelete: Cascade)
  submissions   Submission[]
  
  @@map("assignments")
}

model Submission {
  id            Int        @id @default(autoincrement())
  assignmentId  Int        @map("assignment_id")
  studentId     String     @db.Uuid @map("student_id")
  content       String
  attachmentUrl String?    @map("attachment_url")
  submittedAt   DateTime   @default(now()) @map("submitted_at")
  marksObtained Float?     @map("marks_obtained")
  feedback      String?
  gradedAt      DateTime?  @map("graded_at")
  
  assignment    Assignment @relation(fields: [assignmentId], references: [id], onDelete: Cascade)
  student       Student    @relation(fields: [studentId], references: [id], onDelete: Cascade)
  
  @@unique([assignmentId, studentId])
  @@map("submissions")
}

model Quiz {
  id          Int           @id @default(autoincrement())
  subjectId   Int           @map("subject_id")
  teacherId   String        @db.Uuid @map("teacher_id")
  title       String
  description String?
  questions   Json          // Array of objects: { question, type, options, answer }
  createdAt   DateTime      @default(now()) @map("created_at")
  updatedAt   DateTime      @updatedAt @map("updated_at")

  subject     Subject       @relation(fields: [subjectId], references: [id], onDelete: Cascade)
  teacher     Teacher       @relation(fields: [teacherId], references: [id], onDelete: Cascade)
  attempts    QuizAttempt[]

  @@map("quizzes")
}

model QuizAttempt {
  id          Int      @id @default(autoincrement())
  quizId      Int      @map("quiz_id")
  studentId   String   @db.Uuid @map("student_id")
  answers     Json     // Object: { questionIndex: answer }
  score       Float
  completedAt DateTime @default(now()) @map("completed_at")

  quiz        Quiz     @relation(fields: [quizId], references: [id], onDelete: Cascade)
  student     Student  @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@map("quiz_attempts")
}

model ClassMaterial {
  id          Int      @id @default(autoincrement())
  subjectId   Int      @map("subject_id")
  teacherId   String   @db.Uuid @map("teacher_id")
  title       String
  description String?
  fileUrl     String   @map("file_url")
  fileType    String   @map("file_type")
  createdAt   DateTime @default(now()) @map("created_at")

  subject     Subject  @relation(fields: [subjectId], references: [id], onDelete: Cascade)
  teacher     Teacher  @relation(fields: [teacherId], references: [id], onDelete: Cascade)

  @@map("class_materials")
}
